// src/AdminPage.jsx
import React, { useEffect, useState } from 'react';
const API_BASE = import.meta.env.VITE_API_BASE || '/api';

export default function AdminPage() {
  const [questions, setQuestions] = useState([]);
  const [text, setText] = useState('');
  const [choices, setChoices] = useState(['', '', '', '']);
  const [correctIndex, setCorrectIndex] = useState(0);
  const [testTitle, setTestTitle] = useState('');
  const [selectedIds, setSelectedIds] = useState([]);

  // Fetch questions from backend
  async function fetchQuestions() {
    try {
      const res = await fetch(`${API_BASE}/admin/questions`);
      if (!res.ok) throw new Error('Failed to fetch questions');
      const data = await res.json();
      setQuestions(Array.isArray(data) ? data : []);
    } catch (err) {
      console.error('fetchQuestions error', err);
      alert('Error loading questions (see console)');
    }
  }

  useEffect(() => {
    fetchQuestions();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // Add a new question
  async function addQuestion() {
    if (!text.trim() || choices.some((c) => !c.trim())) {
      alert('Please fill question text and all choices');
      return;
    }

    try {
      const payload = {
        text,
        choices,
        correct_choice_index: correctIndex
      };

      const res = await fetch(`${API_BASE}/admin/questions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const txt = await res.text().catch(() => null);
        throw new Error(txt || 'Failed to add question');
      }

      setText('');
      setChoices(['', '', '', '']);
      setCorrectIndex(0);
      await fetchQuestions();
    } catch (err) {
      console.error('addQuestion error', err);
      alert('Failed to add question (see console)');
    }
  }

  // Create a test from selected question IDs
  async function addTest() {
    if (!testTitle.trim() || selectedIds.length === 0) {
      alert('Please enter a test title and select questions');
      return;
    }

    try {
      const payload = {
        title: testTitle,
        duration_seconds: 300,
        question_ids: selectedIds
      };

      const res = await fetch(`${API_BASE}/admin/tests`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const txt = await res.text().catch(() => null);
        throw new Error(txt || 'Failed to create test');
      }

      const data = await res.json();
      alert('Test created! ID: ' + (data.id ?? 'unknown'));
      setTestTitle('');
      setSelectedIds([]);
    } catch (err) {
      console.error('addTest error', err);
      alert('Failed to create test (see console)');
    }
  }

  // Toggle selection of a question id for test creation
  function toggleSelect(id) {
    setSelectedIds((prev) =>
      prev.includes(id) ? prev.filter((x) => x !== id) : [...prev, id]
    );
  }

  // Remove a question (admin)
  async function deleteQuestion(id) {
    if (!confirm('Delete question?')) return;
    try {
      const res = await fetch(`${API_BASE}/admin/questions/${id}`, {
        method: 'DELETE'
      });
      if (!res.ok) {
        const txt = await res.text().catch(() => null);
        throw new Error(txt || 'Failed to delete question');
      }
      await fetchQuestions();
    } catch (err) {
      console.error('deleteQuestion error', err);
      alert('Failed to delete question (see console)');
    }
  }

  return (
    <div style={{ maxWidth: 900, margin: '20px auto', fontFamily: 'Inter, sans-serif' }}>
      <h1>üßë‚Äçüíº Admin Panel</h1>

      <section style={{ borderBottom: '1px solid #ccc', marginBottom: 20, paddingBottom: 20 }}>
        <h2>Add Question</h2>

        <div style={{ marginBottom: 10 }}>
          <label>
            Question text:
            <textarea
              value={text}
              onChange={(e) => setText(e.target.value)}
              rows="2"
              style={{ width: '100%', marginTop: 6 }}
            />
          </label>
        </div>

        <div style={{ marginBottom: 10 }}>
          <label>Choices (4)</label>
          {choices.map((c, i) => (
            <div key={i} style={{ display: 'flex', gap: 8, marginTop: 6 }}>
              <input
                type="text"
                value={c}
                onChange={(e) => {
                  const next = [...choices];
                  next[i] = e.target.value;
                  setChoices(next);
                }}
                style={{ flex: 1 }}
                placeholder={`Choice ${i + 1}`}
              />
              <label style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                <input
                  type="radio"
                  name="correctChoice"
                  checked={correctIndex === i}
                  onChange={() => setCorrectIndex(i)}
                />{' '}
                correct
              </label>
            </div>
          ))}
        </div>

        <div style={{ marginTop: 12 }}>
          <button onClick={addQuestion}>Add Question</button>
        </div>
      </section>

      <section style={{ borderBottom: '1px solid #ccc', marginBottom: 20, paddingBottom: 20 }}>
        <h2>Create Test</h2>

        <div style={{ marginBottom: 8 }}>
          <label>
            Test title:
            <input
              value={testTitle}
              onChange={(e) => setTestTitle(e.target.value)}
              style={{ width: '100%', marginTop: 6 }}
            />
          </label>
        </div>

        <div style={{ marginBottom: 8 }}>
          <strong>Select questions to include in test:</strong>
          <div style={{ marginTop: 8 }}>
            {questions.length === 0 && <div>No questions yet</div>}
            {questions.map((q) => (
              <div key={q.id} style={{ border: '1px solid #eee', padding: 8, marginBottom: 6 }}>
                <label style={{ display: 'flex', gap: 12, alignItems: 'flex-start' }}>
                  <input
                    type="checkbox"
                    checked={selectedIds.includes(q.id)}
                    onChange={() => toggleSelect(q.id)}
                    style={{ marginTop: 4 }}
                  />
                  <div style={{ flex: 1 }}>
                    <div style={{ fontWeight: 600 }}>{q.text}</div>
                    <div style={{ marginTop: 6 }}>
                      {q.choices?.map((c, idx) => (
                        <div key={idx} style={{ fontSize: 13 }}>
                          {idx === q.correct_choice_index ? <strong>‚úî </strong> : '   '}
                          {c}
                        </div>
                      ))}
                    </div>
                  </div>

                  <div style={{ marginLeft: 8 }}>
                    <button onClick={() => deleteQuestion(q.id)}>Delete</button>
                  </div>
                </label>
              </div>
            ))}
          </div>
        </div>

        <div>
          <button onClick={addTest}>Create Test</button>
        </div>
      </section>
    </div>
  );
}
